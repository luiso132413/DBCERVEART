<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>DBCERVEART — Lotes de producción</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="topbar">
    <h1>DBCERVEART</h1>
    <nav>
      <a href="./index.html">Dashboard</a>
    </nav>
  </header>

  <main class="container">

    <!-- =================== -->
    <!-- FORMULARIO LOTES -->
    <!-- =================== -->
    <section class="panel">
      <div class="panel-header"><h2>Nuevo / Editar lote</h2></div>
      <form id="form-lote">
        <div class="form-stack">
          <label>Código
            <input type="text" name="codigo" required placeholder="L-2025-0001" />
          </label>

          <label>Estilo
            <select name="estilo_id" id="m-estilo" required></select>
          </label>

          <label>Inicio
            <input type="date" name="fecha_inicio" required />
          </label>

          <label>Fin
            <input type="date" name="fecha_fin" />
          </label>

          <label>Volumen (L)
            <input type="number" step="0.01" name="volumen_producido_litros" required />
          </label>

          <label>Estado
            <select name="estado" required>
              <option value="En proceso">En proceso</option>
              <option value="Finalizado">Finalizado</option>
              <option value="Cancelado">Cancelado</option>
            </select>
          </label>

          <input type="hidden" name="lote_id" />
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </section>

    <!-- =================== -->
    <!-- TABLA DE LOTES -->
    <!-- =================== -->
    <section class="panel">
      <div class="panel-header"><h2>Lotes</h2></div>
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th>#</th>
            <th>Código</th>
            <th>Estilo</th>
            <th>Volumen (L)</th>
            <th>Inicio</th>
            <th>Fin</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

  </main>

  <div id="toast" class="toast" hidden></div>
  <script src="./app.js" defer></script>

  <script defer>
  document.addEventListener('DOMContentLoaded', async () => {
    const tbody = document.querySelector('#tbl tbody');
    const form = document.querySelector('#form-lote');
    const selEstilo = document.querySelector('#m-estilo');

    // === Cargar estilos ===
    async function loadEstilos() {
      const estilos = await fetchJSON(`${API}/estilos`);
      selEstilo.innerHTML = estilos
        .map(e => `<option value="${e.estilo_id}">${e.nombre}</option>`)
        .join('');
    }

    // === Cargar lotes ===
    async function loadLotes() {
      const rows = await fetchJSON(`${API}/lotes`);
      render(rows);
    }

    // === Renderizar tabla ===
    function render(rows) {
      tbody.innerHTML = '';
      rows.forEach((r, i) => {
        const estilo = r.Estilo?.nombre || r.estilo_nombre || r.estilo_id;
        const inicio = r.fecha_inicio ? String(r.fecha_inicio).slice(0, 10) : '';
        const fin = r.fecha_fin ? String(r.fecha_fin).slice(0, 10) : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${r.codigo}</td>
          <td>${estilo}</td>
          <td>${Number(r.volumen_producido_litros || 0).toFixed(2)}</td>
          <td>${inicio}</td>
          <td>${fin}</td>
          <td>${r.estado}</td>
          <td>
            <div class="actions-vertical">
              <button class="btn btn-outline" data-edit="${r.lote_id}">Editar</button>
              <button class="btn btn-danger" data-del="${r.lote_id}">Eliminar</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });

      // === Acciones ===
      document.querySelectorAll('[data-edit]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = Number(btn.dataset.edit);
          const data = await fetchJSON(`${API}/lotes/${id}`);
          form.codigo.value = data.codigo || '';
          form.estilo_id.value = data.estilo_id || '';
          form.fecha_inicio.value = data.fecha_inicio ? data.fecha_inicio.slice(0, 10) : '';
          form.fecha_fin.value = data.fecha_fin ? data.fecha_fin.slice(0, 10) : '';
          form.volumen_producido_litros.value = data.volumen_producido_litros || '';
          form.estado.value = data.estado || 'En proceso';
          form.lote_id.value = data.lote_id;
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      });

      document.querySelectorAll('[data-del]').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('¿Eliminar lote?')) return;
          await fetchJSON(`${API}/lotes/${btn.dataset.del}`, { method: 'DELETE' });
          toast('Lote eliminado');
          loadLotes();
        });
      });
    }

    // === Guardar o actualizar ===
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const fd = new FormData(form);
      const data = Object.fromEntries(fd.entries());
      data.estilo_id = Number(data.estilo_id);
      data.volumen_producido_litros = Number(data.volumen_producido_litros || 0);

      try {
        if (data.lote_id) {
          await fetchJSON(`${API}/lotes/${data.lote_id}`, {
            method: 'PUT',
            body: JSON.stringify(data),
          });
          toast('Actualizado correctamente');
        } else {
          await fetchJSON(`${API}/lotes`, {
            method: 'POST',
            body: JSON.stringify(data),
          });
          toast('Creado correctamente');
        }
        form.reset();
        loadLotes();
      } catch (err) {
        toast(err.message || 'Error al guardar', false);
      }
    });

    await loadEstilos();
    await loadLotes();
  });
  </script>
</body>
</html>
