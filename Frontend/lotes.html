<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>DBCERVEART — Lotes de producción</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="./styles.css"/>
</head>
<body>
  <header class="topbar">
    <h1>DBCERVEART</h1>
    <nav>
      <a href="./index.html">Dashboard</a>
      <a href="./lotes.html">Lotes</a>
      <a href="./lotes-embotellado.html">Embotellado</a>
      <a href="./desperdicios.html">Desperdicios</a>
      <a href="./estilos.html">Estilos</a>
      <a href="./envases.html">Envases</a>
      <a href="./causas.html">Causas</a>
    </nav>
  </header>

  <main class="container">
    <section class="panel">
      <div class="panel-header"><h2>Filtros</h2></div>
      <div class="grid" style="grid-template-columns:repeat(6,1fr)">
        <label>Desde <input type="date" id="f-desde"/></label>
        <label>Hasta <input type="date" id="f-hasta"/></label>
        <label>Estado
          <select id="f-estado">
            <option value="">Todos</option>
            <option>En proceso</option>
            <option>Finalizado</option>
            <option>Cancelado</option>
          </select>
        </label>
        <label>Estilo
          <select id="f-estilo"></select>
        </label>
        <button id="btn-filtrar">Aplicar</button>
        <button id="btn-limpiar">Limpiar</button>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header"><h2>Nuevo / Editar lote</h2></div>
      <form id="form-lote">
        <div class="grid" style="grid-template-columns:repeat(6,1fr)">
          <label>Código <input name="codigo" required placeholder="L-2025-0001"/></label>
          <label>Estilo
            <select name="estilo_id" id="m-estilo" required></select>
          </label>
          <label>Inicio <input type="date" name="fecha_inicio" required/></label>
          <label>Fin <input type="date" name="fecha_fin"/></label>
          <label>Volumen (L) <input type="number" step="0.01" name="volumen_producido_litros" required/></label>
          <label>Estado
            <select name="estado" required>
              <option>En proceso</option>
              <option>Finalizado</option>
              <option>Cancelado</option>
            </select>
          </label>
          <input type="hidden" name="lote_id"/>
          <button type="submit">Guardar</button>
        </div>
      </form>
    </section>

    <section class="panel">
      <div class="panel-header"><h2>Lotes</h2></div>
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th>#</th><th>Código</th><th>Estilo</th><th>Volumen (L)</th><th>Inicio</th><th>Fin</th><th>Estado</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <div id="toast" class="toast" hidden></div>
  <script src="./app.js" defer></script>
  <script defer>
  document.addEventListener('DOMContentLoaded', ()=>{
    const tbody = $('#tbl tbody');
    const form = $('#form-lote');
    const selFiltroEstilo = $('#f-estilo');
    const selFormEstilo = $('#m-estilo');
    const fDesde=$('#f-desde'), fHasta=$('#f-hasta'), fEstado=$('#f-estado');

    async function loadEstilos(){
      const estilos = await fetchJSON(`${API}/estilos`);
      selFiltroEstilo.innerHTML = `<option value="">Todos</option>` + estilos.map(e=>`<option value="${e.estilo_id}">${e.nombre}</option>`).join('');
      selFormEstilo.innerHTML = estilos.map(e=>`<option value="${e.estilo_id}">${e.nombre}</option>`).join('');
    }

    function buildQuery(){
      const p = new URLSearchParams();
      if(fDesde.value) p.append('desde', fDesde.value);
      if(fHasta.value) p.append('hasta', fHasta.value);
      if(fEstado.value) p.append('estado', fEstado.value);
      if(selFiltroEstilo.value) p.append('estilo_id', selFiltroEstilo.value);
      return p.toString() ? `?${p.toString()}` : '';
    }

    async function load(){
      const rows = await fetchJSON(`${API}/lotes${buildQuery()}`);
      render(rows);
    }

    function render(rows){
      tbody.innerHTML = '';
      rows.forEach((r,i)=>{
        const tr = document.createElement('tr');
        const estilo = r.Estilo?.nombre ?? r.estilo_nombre ?? r.estilo_id;
        const d1 = r.fecha_inicio ? String(r.fecha_inicio).slice(0,10) : '';
        const d2 = r.fecha_fin ? String(r.fecha_fin).slice(0,10) : '';
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${r.codigo}</td>
          <td>${estilo}</td>
          <td>${Number(r.volumen_producido_litros||0).toFixed(2)}</td>
          <td>${d1}</td>
          <td>${d2}</td>
          <td>${r.estado}</td>
          <td>
            <button data-edit="${r.lote_id}">Editar</button>
            <button data-del="${r.lote_id}">Eliminar</button>
          </td>`;
        tbody.appendChild(tr);
      });

      $$('[data-edit]').forEach(b=>b.onclick = async ()=>{
        const id = Number(b.dataset.edit);
        const r = (await fetchJSON(`${API}/lotes`)).find(x=>x.lote_id===id);
        form.codigo.value = r.codigo || '';
        form.estilo_id.value = r.estilo_id || '';
        form.fecha_inicio.value = r.fecha_inicio ? String(r.fecha_inicio).slice(0,10) : '';
        form.fecha_fin.value = r.fecha_fin ? String(r.fecha_fin).slice(0,10) : '';
        form.volumen_producido_litros.value = r.volumen_producido_litros ?? '';
        form.estado.value = r.estado || 'En proceso';
        form.lote_id.value = r.lote_id;
        window.scrollTo({ top: 0, behavior:'smooth' });
      });

      $$('[data-del]').forEach(b=>b.onclick = async ()=>{
        if(!confirm('¿Eliminar lote?')) return;
        await fetchJSON(`${API}/lotes/${b.dataset.del}`, { method:'DELETE' });
        toast('Eliminado'); load();
      });
    }

    $('#btn-filtrar').onclick = load;
    $('#btn-limpiar').onclick = ()=>{ fDesde.value=''; fHasta.value=''; fEstado.value=''; selFiltroEstilo.value=''; load(); };

    form.onsubmit = async (e)=>{
      e.preventDefault();
      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());
      payload.estilo_id = Number(payload.estilo_id);
      if(payload.volumen_producido_litros) payload.volumen_producido_litros = Number(payload.volumen_producido_litros);
      const id = payload.lote_id;
      try{
        if(id){
          await fetchJSON(`${API}/lotes/${id}`, { method:'PUT', body: JSON.stringify(payload) });
          toast('Actualizado');
        }else{
          await fetchJSON(`${API}/lotes`, { method:'POST', body: JSON.stringify(payload) });
          toast('Creado');
        }
        form.reset(); load();
      }catch(err){ toast(err.message||'Error', false); }
    };

    loadEstilos().then(load);
  });
  </script>
</body>
</html>
