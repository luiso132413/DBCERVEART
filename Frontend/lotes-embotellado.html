<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>DBCERVEART — Embotellado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="./styles.css"/>
</head>
<body>
  <header class="topbar">
    <h1>DBCERVEART</h1>
    <nav>
      <a href="./index.html">Dashboard</a>
    </nav>
  </header>

  <main class="container">
    <!-- Formulario -->
    <section class="panel">
      <div class="panel-header"><h2>Nuevo / Editar embotellado</h2></div>
      <form id="form-emb">
        <div class="grid" style="grid-template-columns:repeat(6,1fr)">
          <label>Fecha <input type="date" name="fecha" required/></label>
          <label>Lote <select name="lote_id" id="m-lote" required></select></label>
          <label>Envase <select name="envase_tipo_id" id="m-envase" required></select></label>
          <label>Cantidad envases <input type="number" name="cantidad_envases" min="1" required/></label>
          <label>Litros usados (opcional) <input type="number" step="0.01" name="litros_usados"/></label>
          <label>Notas <input name="notas"/></label>
          <!-- guardamos aquí el movimiento_id cuando “editemos” -->
          <input type="hidden" name="embotellado_id"/>
          <button type="submit">Guardar</button>
        </div>
      </form>
    </section>

    <!-- Tabla -->
    <section class="panel">
      <div class="panel-header"><h2>Embotellados</h2></div>
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th>#</th><th>Fecha</th><th>Lote</th><th>Envase</th>
            <th>Cant. envases</th><th>Litros usados</th><th>Notas</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <div id="toast" class="toast" hidden></div>

  <!-- Helpers globales -->
  <script src="./app.js" defer></script>

  <!-- Lógica específica usando /api/movimientos (SALIDA + origen=embotellado) -->
  <script defer>
  document.addEventListener('DOMContentLoaded', function(){
    // --- Constantes para este módulo ---
    var MOV_URL    = API + '/movimientos';
    var MOV_TIPO   = 'SALIDA';                // requerido por tu validador
    var TAG_ORIGEN = 'origen=embotellado';    // etiqueta para distinguirlos

    // Refs
    var tbody   = document.querySelector('#tbl tbody');
    var form    = document.querySelector('#form-emb');
    var mLote   = document.querySelector('#m-lote');
    var mEnvase = document.querySelector('#m-envase');

    function safe(v, fb){ return (v === undefined || v === null) ? (fb || '') : v; }

    function getCapacidadMlSelect(sel){
      var opt = sel && sel.options ? sel.options[sel.selectedIndex] : null;
      var cap = opt ? opt.getAttribute('data-cap') : null;
      return Number(cap || 0);
    }
    function recomputeLitros(){
      var capMl = getCapacidadMlSelect(mEnvase);
      var qty   = Number(form.cantidad_envases.value || 0);
      var litros = (capMl/1000) * qty;
      form.litros_usados.value = litros ? litros.toFixed(2) : '';
    }
    function parseLitrosFromDetalle(detalle){
      if(!detalle) return null;
      var m = detalle.toString().match(/litros\s*=\s*([0-9]+(?:\.[0-9]+)?)/i);
      return m ? Number(m[1]) : null;
    }

    // Combos
    function loadCombos(){
      return Promise.all([
        fetchJSON(API + '/lotes'),
        fetchJSON(API + '/envases-tipo')
      ]).then(function(res){
        var lotes   = res[0] || [];
        var envases = res[1] || [];

        var mHtmlL = '';
        for(var i=0;i<lotes.length;i++){
          mHtmlL += '<option value="'+lotes[i].lote_id+'">'+lotes[i].codigo+'</option>';
        }
        mLote.innerHTML = mHtmlL;

        var mHtmlE = '';
        for(var j=0;j<envases.length;j++){
          mHtmlE += '<option value="'+envases[j].envase_tipo_id+'" data-cap="'+envases[j].capacidad_ml+'">'+envases[j].nombre+' ('+envases[j].capacidad_ml+' ml)</option>';
        }
        mEnvase.innerHTML = mHtmlE;
      });
    }

    // Cargar SOLO movimientos SALIDA con origen=embotellado
    function load(){
      return fetchJSON(MOV_URL + '?tipo=' + MOV_TIPO).then(function(resp){
        var rows = resp && resp.data ? resp.data : resp || [];
        var list = [];
        for(var i=0;i<rows.length;i++){
          var r = rows[i];
          var tieneTag = r.detalle && r.detalle.toString().toLowerCase().indexOf('origen=embotellado') !== -1;
          if(tieneTag) list.push(r);
        }
        render(list);
      });
    }

    function render(rows){
      tbody.innerHTML = '';
      for(var i=0;i<rows.length;i++){
        var r = rows[i];

        var lote  = safe(r.Lote && r.Lote.codigo, safe(r.lote_id, ''));
        var env   = safe(r.EnvaseTipo && r.EnvaseTipo.nombre, safe(r.envase_tipo_id, ''));
        var cap   = safe(r.EnvaseTipo && r.EnvaseTipo.capacidad_ml, '');
        var fecha = r.fecha ? String(r.fecha).slice(0,10) : '';

        var cant  = safe(r.cantidad, '');
        var litros = parseLitrosFromDetalle(r.detalle);
        if(litros === null && cap && cant){
          litros = (Number(cap)/1000) * Number(cant);
        }
        var litrosTxt = (Number(litros||0)).toFixed(2);

        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td>'+(i+1)+'</td>'+
          '<td>'+fecha+'</td>'+
          '<td>'+lote+'</td>'+
          '<td>'+env+(cap ? (' ('+cap+' ml)') : '')+'</td>'+
          '<td>'+cant+'</td>'+
          '<td>'+litrosTxt+'</td>'+
          '<td>'+safe(r.detalle, '')+'</td>'+
          '<td>'+
            '<button data-edit="'+r.movimiento_id+'">Editar</button> '+
            '<button data-del="'+r.movimiento_id+'">Eliminar</button>'+
          '</td>';
        tbody.appendChild(tr);
      }

      // Editar: precargar form (luego haremos DELETE+POST)
      var edits = document.querySelectorAll('[data-edit]');
      for(var e=0;e<edits.length;e++){
        edits[e].onclick = function(){
          var id = Number(this.getAttribute('data-edit'));
          fetchJSON(MOV_URL + '?tipo=' + MOV_TIPO).then(function(resp){
            var all = resp && resp.data ? resp.data : resp || [];
            var r = null;
            for(var a=0;a<all.length;a++){
              if(Number(all[a].movimiento_id) === id){ r = all[a]; break; }
            }
            if(!r) return;

            form.fecha.value            = r.fecha ? String(r.fecha).slice(0,10) : '';
            form.lote_id.value          = r.lote_id || '';
            form.envase_tipo_id.value   = r.envase_tipo_id || '';
            form.cantidad_envases.value = r.cantidad || '';

            var lit = parseLitrosFromDetalle(r.detalle);
            if(lit !== null) form.litros_usados.value = Number(lit).toFixed(2);
            else             recomputeLitros();

            form.notas.value            = safe(r.detalle, '');
            form.embotellado_id.value   = r.movimiento_id;
            window.scrollTo({ top: 0, behavior:'smooth' });
          });
        };
      }

      // Eliminar
      var dels = document.querySelectorAll('[data-del]');
      for(var d=0; d<dels.length; d++){
        dels[d].onclick = function(){
          if(!confirm('¿Eliminar embotellado?')) return;
          var id = this.getAttribute('data-del');
          fetchJSON(MOV_URL + '/' + id, { method:'DELETE' })
            .then(function(){ toast('Eliminado'); load(); })
            .catch(function(err){ toast(err.message || 'Error', false); });
        };
      }
    }

    // Autocálculo
    if(mEnvase) mEnvase.addEventListener('change', recomputeLitros);
    if(form.cantidad_envases) form.cantidad_envases.addEventListener('input', recomputeLitros);

    // Guardar: SALIDA + origen=embotellado  (si hay id => DELETE + POST)
    form.addEventListener('submit', function(e){
      e.preventDefault();
      var fd = new FormData(form);
      var payload = {};
      fd.forEach(function(v,k){ payload[k] = v; });

      // detalle: notas + tag + litros
      var detalle  = payload.notas ? String(payload.notas) : '';
      if(detalle) detalle += ' | ';
      detalle += TAG_ORIGEN;
      if(payload.litros_usados){
        var litNumber = Number(payload.litros_usados);
        if(!isNaN(litNumber)) detalle += ' | litros=' + litNumber.toFixed(2);
      }

      var body = {
        tipo: MOV_TIPO,                            // 'SALIDA'
        fecha: payload.fecha,                      // YYYY-MM-DD
        envase_tipo_id: Number(payload.envase_tipo_id),
        lote_id: Number(payload.lote_id),
        cantidad: Number(payload.cantidad_envases),
        detalle: detalle
      };

      // Si no tienes stock suficiente, tu backend devolverá 400 con error de stock
      var id = payload.embotellado_id;
      var save = function(){ return fetchJSON(MOV_URL, { method:'POST', body: JSON.stringify(body) }); };
      var flow = id ? fetchJSON(MOV_URL + '/' + id, { method:'DELETE' }).then(save) : save();

      flow.then(function(){
        toast(id ? 'Actualizado' : 'Creado');
        form.reset();
        load();
      }).catch(function(err){
        toast(err.message || 'Error', false);
        console.error(err);
      });
    });

    loadCombos().then(load).catch(function(err){
      console.error(err); toast('Error cargando datos', false);
    });
  });
  </script>
</body>
</html>
